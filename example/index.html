<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <script src="main.js">
  </script>
</head>

<body>
  <script>
    // For the demo page we mount the Example module, not Main.
    // Browser.element expects a node + flags. Our DMXPage uses flags : ().
    window.app = Elm.DMXPage.init({ node: document.body, flags: null })

    // Optional: only wire ports that actually exist on this module.
    if (app.ports && app.ports.store) {
      const storedData = localStorage.getItem('dm6-elm')
      const model = storedData ? JSON.parse(storedData) : null
      app.ports.store.subscribe(function (model) {
        localStorage.setItem('dm6-elm', JSON.stringify(model))
      })
    }

    /* no log port subscription here â€” dev remains clean */

    (function () {
    // If you prefer, make this configurable in Elm and pass via flags.
    const BASE = "https://dmx.ralfbarkow.ch";

    function toHeaders(pairs) {
      const h = new Headers();
      (pairs || []).forEach(([k, v]) => h.append(k, v));
      return h;
    }

    function normalizeUrl(url) {
      if (/^https?:\/\//i.test(url)) return url;
      return BASE.replace(/\/$/, "") + "/" + url.replace(/^\//, "");
    }

    if (app.ports && app.ports.dmxRequest && app.ports.dmxResponse && app.ports.dmxError) {
      app.ports.dmxRequest.subscribe(async (req) => {
      const url = normalizeUrl(req.url);
      const init = {
        method: req.method,
        headers: toHeaders(req.headers),
        credentials: req.withCredentials ? "include" : "same-origin"
      };
      if (req.method !== "GET" && req.method !== "HEAD") {
        init.body = JSON.stringify(req.body ?? null);
        if (!init.headers.has("Content-Type")) {
          init.headers.set("Content-Type", "application/json");
        }
      }
      try {
        const res = await fetch(url, init);
        const text = await res.text();
        let data;
        try { data = text ? JSON.parse(text) : null; } catch (_) { data = text; }
        app.ports.dmxResponse.send({
          id: req.id,
          status: res.status,
          ok: res.ok,
          data
        });
      } catch (e) {
        app.ports.dmxError.send({ id: req.id, message: String(e) });
      }
    });
  }
  })();
  </script>

</body>

</html>