<!doctype html>
<meta charset="utf-8">
<title>dm6 wiki console</title>
<link href="https://cdn.jsdelivr.net/npm/@observablehq/inspector@5.0.1/dist/inspector.min.css" rel="stylesheet">
<style>
  :root{ --pad:10px; --muted:#666; --line:#eee; --ring:#ccc; --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  html,body{ height:100% }
  body{ margin:0; font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  details{ border-bottom:1px solid var(--line) }
  summary{ list-style:none; cursor:pointer; padding:8px var(--pad); display:flex; gap:8px; align-items:center }
  summary::-webkit-details-marker{ display:none }
  .spacer{ flex:1 }
  .muted{ color:var(--muted); font-size:12px }
  .btn{ padding:4px 8px; border:1px solid var(--ring); border-radius:6px; background:#fafafa; cursor:pointer }
  .btn:hover{ background:#f0f0f0 }
  #elmMount{ min-height:140px; height:40vh; resize:vertical; overflow:auto; padding:0; }
  #jqbar{ display:flex; gap:8px; align-items:center; padding:8px var(--pad) }
  #jq{ flex:1; border:1px solid var(--ring); height:2.1rem; padding:.35rem .55rem; font:13px/1.35 var(--mono) }
  #result{ max-height:28vh; overflow:auto; padding:0 var(--pad) var(--pad) var(--pad) }
  #flags{ font-size:12px; color:var(--muted) }
  @media (max-width:420px){
    #elmMount{ height:34vh }
    #result{ max-height:24vh }
  }
</style>

<div id="toolbar">
  <button id="bootPage">Boot JSON</button>
  <button id="bootEmpty">Cold {}</button>
  <span class="spacer"></span>
  <span id="status" class="muted">waiting…</span>
</div>

<div id="app"></div>


<!-- jq pane -->
<details id="jqPane" open>
  <summary>
    <strong>jq</strong>
    <span class="muted" id="jqMeta"></span>
    <span class="spacer"></span>
    <button id="run" class="btn">Run</button>
  </summary>
  <div id="jqbar">
    <input id="jq" list="jq-presets" placeholder=".title · .story|length · .story[]|.type" />
  </div>
  <div id="result"></div>
</details>

<!-- IMPORTANT: this elm.js must be built from AppEmbed.elm (Browser.element) -->
<script src="elm.js"></script>

<!-- jq runtime (globals: window.jq) -->
<script src="https://dobbs.github.io/wiki-jq/jq.js"></script>

<script type="module">
  import * as frames from 'https://wiki.dbbs.co/assets/v1/frame.js'
  import {Inspector} from 'https://cdn.jsdelivr.net/npm/@observablehq/inspector@5.0.1/+esm'

  // ---------- Elements ----------
  const $mount  = document.getElementById('app')
  const $status = document.getElementById('status')
  const $jq     = document.getElementById('jq')
  const $run    = document.getElementById('run')
  const $jqMeta  = document.getElementById('jqMeta')
  const inspector = new Inspector(document.getElementById('result'))

  // ---------- Helpers ----------
  const asSlug = t => String(t||'').replace(/\s/g,'-').replace(/[^A-Za-z0-9-]/g,'').toLowerCase()

  function pickElmModule() {
    if (!window.Elm) { console.error('elm.js not loaded'); return null }
    // Prefer embedded element entrypoint if present
    return window.Elm.AppEmbed || window.Elm.AppMain || window.Elm.Main || null
  }

  // ---------- Elm boot ----------
  function bootElm(flags){
    const App = pickElmModule()
    if (!App) {
      $status.textContent = 'No Elm module found. Check elm.js build/paths.'
      return null
    }
    const mount = document.createElement('div')
    mount.style.height = '100%'
    $mount.replaceChildren(mount)
    const app = App.init({ node: mount, flags })
    const name = (App === window.Elm.AppEmbed ? 'AppEmbed' : App === window.Elm.AppMain ? 'AppMain' : 'Main')
    $status.textContent = `Elm(${name}) flags { slug:"${flags.slug}", storedLen:${flags.stored.length} }`
    
    // Send FedWiki page JSON to Elm if the port exists
    if (app.ports?.pageJson) {
      try {
        const raw = JSON.stringify(window.data ?? {})
        app.ports.pageJson.send(raw)
        console.log('pageJson → Elm', raw.length, 'bytes')
      } catch (e) {
        console.error(e)
      }
    }

    // Optional: observe outgoing ports in console (keeps jq panel free)
    if (app.ports?.store)   app.ports.store.subscribe(v => console.log('store',   String(v).length,   'bytes'))
    if (app.ports?.persist) app.ports.persist.subscribe(v => console.log('persist', String(v).length,   'bytes'))
    return app
  }

  // ---------- jq wiring ----------
  let lastRanAt = 0
  async function runJq(filter) {
    const started = performance.now()
    inspector.pending()
    try{
      if(!window.jq || typeof window.jq.json !== 'function')
        throw new Error('jq runtime not loaded (jq.json unavailable)')
      const data = window.data ?? {}
      const result = await window.jq.json(data, String(filter||'').trim() || '.')
      inspector.fulfilled(result)
      const ms = Math.max(1, Math.round(performance.now() - started))
      const bytes = typeof result === 'string' ? result.length : JSON.stringify(result).length
      lastRanAt = Date.now()
      $jqMeta.textContent = `ok • ${bytes}B • ${ms}ms`
    }catch(err){
      $jqMeta.textContent = 'error'
      inspector.rejected(err)
    }
  }

  // UI events
  $run.onclick = () => runJq($jq.value)
  $jq.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); $run.click() }
  })

  // FedWiki context handshake
  let ctx = {}
  try {
    inspector.pending()
    ctx = await frames.context()
    inspector.fulfilled({ site: ctx.site, title: ctx.title })
  } catch (e) {
    inspector.rejected(e)
    ctx = { site: location.host, title: 'dm6-elm-demo', page: {} }
  }

  // Expose page JSON for jq, like the jq wiki console
  window.data = ctx.page
  const slug = asSlug(ctx.title)

  // Buttons: boot Elm with page JSON or {}
  document.getElementById('bootPage').onclick = () =>
    bootElm({ slug, stored: JSON.stringify(window.data ?? {}) })

  document.getElementById('bootEmpty').onclick = () =>
    bootElm({ slug, stored: "{}" })

  // Auto-boot with page JSON and focus jq input
  document.getElementById('bootPage').click()
  $jq.value = '.title'
  $jq.focus()
  // First run shows something immediately
  runJq($jq.value)
</script>
