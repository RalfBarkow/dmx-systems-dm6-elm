<!doctype html>
<meta charset="utf-8">
<title>dm6 wiki console</title>

<div id="toolbar">
  <button id="bootPage">Boot JSON</button>
  <button id="bootEmpty">Cold {}</button>
  <span id="status"></span>
</div>

<div id="app"></div>

<div id="jqbar">
  <label for="jq">jq</label>
  <input id="jq" placeholder=".title · .story|length · .story[]|.type">
  <button id="run">Run</button>
</div>

<div id="result"></div>

<!-- IMPORTANT: elm.js must be built from AppEmbed.elm (Browser.element) -->
<script src="elm.js"></script>

<!-- jq runtime (globals: window.jq) -->
<script src="https://dobbs.github.io/wiki-jq/jq.js"></script>

<!-- Small viewer for jq results (no theming needed) -->
<script type="module">
  import * as frames from 'https://wiki.dbbs.co/assets/v1/frame.js'
  import {Inspector} from 'https://cdn.jsdelivr.net/npm/@observablehq/inspector@5.0.1/+esm'

  // Elements
  const $mount   = document.getElementById('app')
  const $status  = document.getElementById('status')
  const $jq      = document.getElementById('jq')
  const $run     = document.getElementById('run')
  const inspector = new Inspector(document.getElementById('result'))

  // Helpers
  const asSlug = t => String(t||'').replace(/\s/g,'-').replace(/[^A-Za-z0-9-]/g,'').toLowerCase()

  function pickElmModule () {
    if (!window.Elm) { console.error('elm.js not loaded'); return null }
    return window.Elm.AppEmbed || window.Elm.AppMain || window.Elm.Main || null
  }

  function bootElm (flags) {
    const App = pickElmModule()
    if (!App) { $status.textContent = 'No Elm module found.'; return null }

    const mount = document.createElement('div')
    $mount.replaceChildren(mount)

    const app  = App.init({ node: mount, flags })
    const name = (App === window.Elm.AppEmbed ? 'AppEmbed' : App === window.Elm.AppMain ? 'AppMain' : 'Main')
    $status.textContent = `Elm(${name}) flags { slug:"${flags.slug}", storedLen:${flags.stored.length} }`

    // Send FedWiki page JSON to Elm if the port exists
    if (app.ports?.pageJson) {
      try {
        const raw = JSON.stringify(window.data ?? {})
        app.ports.pageJson.send(raw)
        console.log('pageJson → Elm', raw.length, 'bytes')
      } catch (e) {
        console.error(e)
      }
    }

    // Optional: observe outgoing ports in console (keeps jq panel free)
    if (app.ports?.store)   app.ports.store.subscribe(v => console.log('store',   String(v).length,   'bytes'))
    if (app.ports?.persist) app.ports.persist.subscribe(v => console.log('persist', String(v).length,   'bytes'))

    return app
  }

  // jq runner against FedWiki page JSON (window.data)
  async function runJq (filter) {
    inspector.pending()
    try {
      if (!window.jq || typeof window.jq.json !== 'function') throw new Error('jq runtime not loaded')
      const data   = window.data ?? {}
      const result = await window.jq.json(data, String(filter || '').trim() || '.')
      inspector.fulfilled(result)
    } catch (err) {
      inspector.rejected(err)
    }
  }

  // UI events
  $run.onclick = () => runJq($jq.value)
  $jq.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); $run.click() }
  })

  // FedWiki context handshake
  let ctx = {}
  try {
    ctx = await frames.context()
  } catch (e) {
    console.warn('frames.context failed; falling back', e)
    ctx = { site: location.host, title: document.title || 'dm6-elm-demo', page: {} }
  }

  // Expose page JSON for jq, derive slug, wire buttons
  window.data = ctx.page
  const slug  = asSlug(ctx.title)

  document.getElementById('bootPage').onclick  = () => bootElm({ slug, stored: JSON.stringify(window.data ?? {}) })
  document.getElementById('bootEmpty').onclick = () => bootElm({ slug, stored: "{}" })

  // First boot + first jq run
  document.getElementById('bootPage').click()
  $jq.value = '.title'
  $jq.focus()
  runJq($jq.value)
</script>
