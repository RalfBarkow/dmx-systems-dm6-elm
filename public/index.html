<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>dm6-elm</title>
    <style>
      html, body, #app { height: 100%; margin: 0; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <!-- Load Elm bundle (NOT as a module) -->
    <script src="./elm.js"></script>
    <script>
      // Persist the Elm model via localStorage
      const KEY = 'dm6-elm-model';

      function loadFlags() {
        try {
          const raw = localStorage.getItem(KEY);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          console.warn('Could not parse stored model', e);
          return null;
        }
      }

      // Elm exposes a global `Elm` object when loaded via plain <script>
      const app = Elm.Main.init({
        node: document.getElementById('app'),
        flags: loadFlags()
      });

      // Wire the outgoing port: port store : E.Value -> Cmd msg
      let t;
      function save(value) {
        try {
          localStorage.setItem(KEY, JSON.stringify(value));
        } catch (e) {
          console.error('store port failed', e);
        }
      }
      if (app.ports && app.ports.store) {
        app.ports.store.subscribe((val) => {
          clearTimeout(t);
          t = setTimeout(() => save(val), 50);
        });
      }
    </script>
  </body>
</html>
